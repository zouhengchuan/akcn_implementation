#include <stdint.h>
#include "params.h"
#include "reduce.h"
#include "ntt.h"

int16_t zetas[384] = { 1033, 886, 1937, 1886, 624, 704, 1742, 813, 1197, 2946, 2863, 2255, 2500, 3441, 137, 3257, 2569, 2987, 2728, 1039, 963, 2682, 3395, 2412, 2429, 1854, 978, 2433, 1909, 115, 1392, 3166, 78, 88, 975, 1100, 2041, 3455, 3042, 3432, 2281, 2928, 2585, 2030, 341, 562, 2534, 111, 2328, 765, 1444, 920, 2147, 1004, 910, 2179, 2662, 2826, 2162, 755, 1668, 1350, 108, 3047, 152, 3008, 1900, 3030, 2825, 1503, 2471, 3231, 2229, 1717, 1935, 2449, 1285, 2868, 506, 1280, 1003, 2018, 438, 1026, 1470, 3254, 1090, 2648, 1631, 3347, 1374, 2082, 1770, 1731, 1383, 2624, 636, 2579, 1036, 2853, 2814, 2377, 605, 328, 1048, 1271, 2729, 331, 919, 2721, 2845, 1171, 3378, 620, 741, 836, 1966, 1243, 376, 3438, 1457, 2087, 2656, 160, 674, 3331, 1511, 1882, 1434, 968, 3139, 582, 647, 1550, 1086, 2489, 3155, 673, 2902, 1926, 640, 2599, 2939, 2784, 2645, 124, 614, 3103, 164, 3227, 1034, 3333, 2953, 1729, 2050, 361, 221, 2090, 761, 1728, 3089, 1501, 125, 1681, 3344, 3182, 1269, 1956, 10, 940, 316, 1108, 2314, 2048, 3291, 2517, 1515, 3435, 2933, 1401, 1414, 1379, 2507, 22, 1894, 3206, 390, 1999, 3381, 1748, 364, 251, 2555, 1685, 1227, 3163, 80, 1391, 2528, 1772, 513, 2725, 1000, 417, 2553, 3142, 3238, 732, 3394, 3430, 2849, 1248, 1324, 1221, 3120, 27, 1749, 2049, 2722, 3239, 941, 1831, 2771, 1408, 2594, 1095, 1768, 2394, 2882, 32, 2572, 2362, 418, 1022, 1455, 1543, 1312, 2565, 1358, 2435, 1101, 3183, 913, 2678, 1719, 2404, 1774, 274, 1041, 1588, 2474, 2269, 1663, 400, 2770, 1869, 3044, 3449, 2160, 1138, 3302, 1130, 2016, 8, 2247, 223, 3248, 1984, 23, 2207, 2801, 3234, 3363, 2856, 1178, 1660, 1756, 1059, 869, 601, 2445, 3357, 1208, 397, 2282, 297, 897, 100, 1456, 559, 1760, 2586, 898, 3145, 2795, 2898, 2215, 2135, 854, 3105, 915, 1783, 1258, 1322, 1972, 943, 1472, 3274, 2071, 760, 452, 2514, 1224, 1802, 3417, 1212, 451, 3014, 1115, 1655, 713, 1786, 406, 31, 435, 1817, 3375, 1671, 1277, 1206, 252, 3025, 270, 774, 1618, 2251, 1602, 1943, 151, 2761, 2878, 1247, 3137, 1514, 1948, 1583, 1405, 2116, 2740, 242, 159, 1874, 709, 2248, 971, 1723, 2275, 514, 2750, 1209, 2705, 3020, 2510, 2530, 220, 2093, 38, 437, 153, 2945, 3452, 235, 2217, 3180, 2300, 512, 691, 444, 1785, 2524, 184, 2968, 1666, 3013 };

int16_t zetas_inv[256] = { 1975, 1791, 2363, 1672, 3374, 1157, 158, 5, 182, 3419, 195, 947, 2982, 707, 3195, 2486, 2581, 3298, 543, 2052, 3198, 320, 1451, 3306, 2109, 1839, 1025, 3205, 517, 82, 307, 3051, 2793, 2342, 1264, 40, 1619, 3005, 500, 1985, 3114, 2199, 1361, 2603, 1560, 662, 3153, 1697, 1385, 2560, 1237, 2249, 887, 2588, 2185, 2279, 679, 656, 2456, 209, 1286, 1441, 884, 1297, 2350, 687, 2024, 983, 3402, 1683, 188, 2544, 3411, 2099, 2420, 2002, 310, 885, 826, 1689, 1627, 686, 2484, 735, 1661, 337, 545, 608, 2772, 219, 2970, 2457, 1009, 929, 1328, 2230, 3017, 3093, 1504, 3067, 2364, 950, 2039, 524, 2480, 166, 3151, 3141, 2075, 2188, 2964, 3332, 2917, 2696, 903, 1407, 2587, 2423, 2031, 2843, 1158, 518, 253, 555, 3018, 2371, 1752, 318, 1575, 1946, 126, 2783, 3297, 801, 1370, 2000, 19, 3081, 2214, 1491, 2621, 2716, 2837, 79, 2286, 612, 736, 2538, 3126, 728, 2186, 2409, 3129, 2852, 1080, 643, 604, 2421, 878, 2821, 833, 2074, 1726, 1687, 1375, 2083, 110, 1826, 809, 2367, 203, 1987, 2431, 3019, 1439, 2454, 2177, 2951, 589, 2172, 1008, 1522, 1740, 1228, 226, 986, 1954, 632, 427, 1557, 449, 3305, 410, 3349, 2107, 1789, 2702, 1295, 631, 795, 1278, 2547, 2453, 1310, 2537, 2013, 2692, 1129, 3346, 923, 2895, 3116, 1427, 872, 529, 1176, 25, 415, 2, 1416, 2357, 2482, 3369, 3379, 291, 2065, 3342, 1548, 1024, 2479, 1603, 1028, 1045, 62, 775, 2494, 2418, 729, 470, 888, 200, 3320, 16, 957, 1202, 594, 511, 2260, 2644, 1715, 2753, 2833, 1571, 1520, 1665, 2571 };

void basemul(int16_t c[2],
    const int16_t a[2],
    const int16_t b[2],
    int16_t zeta)
{
	int16_t temp[2];

	temp[0] = fqmul(a[0], b[0]);
	temp[1] = fqmul(a[1], b[1]);

	c[0] = fqmul(temp[1], zeta);
	c[0] += temp[0];

	c[1] = fqmul((a[0] + a[1]), (b[0] + b[1]));
	c[1] = c[1] - temp[0] - temp[1];
}

/********TFNTT_ntt********/
static void ntt_384(int16_t a[384]) {
	unsigned int start, j, k, len;
	int16_t t, s, r, zeta, zeta1, rho = zetas[0];

	for (j = 0; j < 192; ++j) {
		t = fqmul(zetas[1], a[j + 192]);
		a[j + 192] = a[j] + a[j + 192] - t;
		a[j] = a[j] + t;
	}

	k = 2;

	for (len = 96; len >= 3; len >>= 1)
	{
		for (start = 0; start < 384; start = j + len)
		{
			zeta = zetas[k++];
			for (j = start; j < start + len; ++j)
				{
					t = fqmul(zeta, a[j + len]);
					a[j + len] = (a[j] - t);
					a[j] = (a[j] + t);
				}
		}
	}

    for (start = 0; start < 384; start += 3) {
		zeta = zetas[k++];
		zeta1 = zetas[k++];
		for (j = start; j < start + 1; ++j) {
			t = fqmul(zeta, a[j + 1]);
			s = fqmul(zeta1, a[j + 2]);
			r = fqmul(rho, s - t);

			a[j + 1] = barrett_reduce(a[j] - s - r);
			a[j + 2] = barrett_reduce(a[j] - t + r);
			a[j] = barrett_reduce(a[j] + t + s);
		}
	}
}

void ntt(int16_t a[768])
{
	int i;
	int16_t a0[384], a1[384];

	for (i = 0; i < 384; i++)
	{
		a0[i] = a[2 * i];
		a1[i] = a[2 * i + 1];
	}
	ntt_384(a0);
	ntt_384(a1);

	for (i = 0; i < 384; i++)
	{
		a[2 * i] = a0[i];
		a[2 * i + 1] = a1[i];
	}

}


/*
void ntt(int16_t a[768]) {
	unsigned int start, j, k, len;
	int16_t t, s, r, zeta, zeta1, rho = zetas[0];

	for (j = 0; j < 384; ++j) {
		t = fqmul(zetas[1], a[j + 384]);
		a[j + 384] = a[j] + a[j + 384] - t;
		a[j] = a[j] + t;
	}

	k = 2;
	for (len = 192; len >= 6; len >>= 1)
	{
		for (start = 0; start < 768; start = j + len)
		{
			zeta = zetas[k++];
			for (j = start; j < start + len; ++j)
				{
					t = fqmul(zeta, a[j + len]);
					a[j + len] = (a[j] - t);
					a[j] = (a[j] + t);
				}
		}
	}

    for (start = 0; start < 768; start += 6) {
		zeta = zetas[k++];
		zeta1 = zetas[k++];
		for (j = start; j < start + 2; ++j) {
			t = fqmul(zeta, a[j + 2]);
			s = fqmul(zeta1, a[j + 4]);
			r = fqmul(rho, s - t);

			a[j + 2] = barrett_reduce(a[j] - s - r);
			a[j + 4] = barrett_reduce(a[j] - t + r);
			a[j] = barrett_reduce(a[j] + t + s);
		}
	}
}
*/

/********TFNTT_invntt********/
static void invntt_256(int16_t a[384]) {
	unsigned int start, j, k, len;
	int16_t t, s, r, zeta, rho = zetas_inv[255];

	k = 0;

    for (start = 0; start < 384; start += 3) {
		zeta = zetas_inv[k++];
		for (j = start; j < start + 1; ++j) {
			r = fqmul(rho, a[j + 1] - a[j + 2]);
			t = a[j] - a[j + 2] + r;
			s = a[j] - a[j + 1] - r;

            a[j] = a[j] + a[j + 1] + a[j + 2];

			a[j + 1] = fqmul(zeta, t);

			a[j + 2] = fqmul(zeta, s);
			a[j + 2] = fqmul(zeta, a[j + 2]);
		}
	}

	for (len = 3; len <= 96; len <<= 1){
		for (start = 0; start < 384; start = j + len) {
			zeta = zetas_inv[k++];
			for (j = start; j < start + len; ++j) {
				t = a[j];
				a[j] = barrett_reduce(t + a[j + len]);
				a[j + len] = t - a[j + len];
				a[j + len] = fqmul(zeta, a[j + len]);
			}
		}
	}

	for (j = 0; j < 192; ++j) {
		t = a[j] - a[j + 192];
		t = fqmul(zetas_inv[254], t);
		a[j] = a[j] + a[j + 192];
		a[j] = a[j] - t;
		a[j] = fqmul(2568, a[j]); // 2^32 * 384^{-1} mod Q
		a[j + 192] = fqmul(1679, t); // 2^32 * 192^{-1} mod Q
	}
}

void invntt(int16_t a[768]) // 蒙哥马利域上的intt，同时退出蒙哥马利域
{
	int i;
	int16_t a0[384], a1[384];

	for (i = 0; i < 384; i++)
	{
		a0[i] = a[2 * i];
		a1[i] = a[2 * i + 1];
	}
	invntt_256(a0);
	invntt_256(a1);

	for (i = 0; i < 384; i++)
	{
		a[2 * i] = a0[i];
		a[2 * i + 1] = a1[i];
	}
}
