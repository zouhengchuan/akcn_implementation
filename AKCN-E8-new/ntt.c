#include <stdint.h>
#include "params.h"
#include "reduce.h"
#include "ntt.h"

int16_t zetas[256] = { 1033, 886, 1937, 1886, 624, 704, 1742, 813, 1197, 2946, 2863, 2255, 2500, 3441, 137, 3257, 2569, 2987, 2728, 1039, 963, 2682, 3395, 2412, 2429, 1854, 978, 2433, 1909, 115, 1392, 3166, 78, 88, 975, 1100, 2041, 3455, 3042, 3432, 2281, 2928, 2585, 2030, 341, 562, 2534, 111, 2328, 765, 1444, 920, 2147, 1004, 910, 2179, 2662, 2826, 2162, 755, 1668, 1350, 108, 3047, 152, 3008, 1900, 3030, 2825, 1503, 2471, 3231, 2229, 1717, 1935, 2449, 1285, 2868, 506, 1280, 1003, 2018, 438, 1026, 1470, 3254, 1090, 2648, 1631, 3347, 1374, 2082, 1770, 1731, 1383, 2624, 636, 2579, 1036, 2853, 2814, 2377, 605, 328, 1048, 1271, 2729, 331, 919, 2721, 2845, 1171, 3378, 620, 741, 836, 1966, 1243, 376, 3438, 1457, 2087, 2656, 160, 674, 3331, 1511, 1882, 1434, 3139, 647, 1086, 3155, 2902, 640, 2939, 2645, 614, 164, 1034, 2953, 2050, 221, 761, 3089, 125, 3344, 1269, 10, 316, 2314, 3291, 1515, 2933, 1414, 2507, 1894, 390, 3381, 364, 2555, 1227, 80, 2528, 513, 1000, 2553, 3238, 3394, 2849, 1324, 3120, 1749, 2722, 941, 2771, 2594, 1768, 2882, 2572, 418, 1455, 1312, 1358, 1101, 913, 1719, 1774, 1041, 2474, 1663, 2770, 3044, 2160, 3302, 2016, 2247, 3248, 23, 2801, 3363, 1178, 1756, 869, 2445, 1208, 2282, 897, 1456, 1760, 898, 2795, 2215, 854, 915, 1258, 1972, 1472, 2071, 452, 1224, 3417, 451, 1115, 713, 406, 435, 3375, 1277, 252, 270, 1618, 1602, 151, 2878, 3137, 1948, 1405, 2740, 159, 709, 971, 2275, 2750, 2705, 2510, 220, 38, 153, 3452, 2217, 2300, 691, 1785, 184, 1666 };

int16_t zetas_inv[256] = { 318, 1752, 2371, 3018, 555, 253, 518, 1158, 2843, 2031, 2423, 2587, 1407, 903, 2696, 2917, 3332, 2964, 2188, 2075, 3141, 3151, 166, 2480, 524, 2039, 950, 2364, 3067, 1504, 3093, 3017, 2230, 1328, 929, 1009, 2457, 2970, 219, 2772, 608, 545, 337, 1661, 735, 2484, 686, 1627, 1689, 826, 885, 310, 2002, 2420, 2099, 3411, 2544, 188, 1683, 3402, 983, 2024, 687, 2350, 1297, 884, 1441, 1286, 209, 2456, 656, 679, 2279, 2185, 2588, 887, 2249, 1237, 2560, 1385, 1697, 3153, 662, 1560, 2603, 1361, 2199, 3114, 1985, 500, 3005, 1619, 40, 1264, 2342, 2793, 3051, 307, 82, 517, 3205, 1025, 1839, 2109, 3306, 1451, 320, 3198, 2052, 543, 3298, 2581, 2486, 3195, 707, 2982, 947, 195, 3419, 182, 5, 158, 1157, 3374, 1672, 2363, 1791, 1975, 3305, 449, 1557, 427, 632, 1954, 986, 226, 1228, 1740, 1522, 1008, 2172, 589, 2951, 2177, 2454, 1439, 3019, 2431, 1987, 203, 2367, 809, 1826, 110, 2083, 1375, 1687, 1726, 2074, 833, 2821, 878, 2421, 604, 643, 1080, 2852, 3129, 2409, 2186, 728, 3126, 2538, 736, 612, 2286, 79, 2837, 2716, 2621, 1491, 2214, 3081, 19, 2000, 1370, 801, 3297, 2783, 126, 1946, 1575, 3379, 3369, 2482, 2357, 1416, 2, 415, 25, 1176, 529, 872, 1427, 3116, 2895, 923, 3346, 1129, 2692, 2013, 2537, 1310, 2453, 2547, 1278, 795, 631, 1295, 2702, 1789, 2107, 3349, 410, 888, 470, 729, 2418, 2494, 775, 62, 1045, 1028, 1603, 2479, 1024, 1548, 3342, 2065, 291, 2260, 511, 594, 1202, 957, 16, 3320, 200, 2833, 2753, 1715, 2644, 1520, 1571, 1665, 2571 };

void basemul(int16_t c[2],
    const int16_t a[2],
    const int16_t b[2],
    int16_t zeta)
{
    c[0] = fqmul(a[1], b[1]);
    c[0] = fqmul(c[0], zeta);
    c[0] += fqmul(a[0], b[0]);

    c[1] = fqmul(a[1], b[0]);
    c[1] += fqmul(a[0], b[1]);
}

/********TFNTT_ntt********/
static void ntt_384(int16_t a[384]) {
	unsigned int start, j, k;
	int16_t t, zeta;

	for (j = 0; j < 192; ++j) {
		t = fqmul(zetas[1], a[j + 192]);
		a[j + 192] = a[j] + a[j + 192] - t;
		a[j] = a[j] + t;
	}

	k = 2;

    for (start = 0; start < 384; start = j + 96) {
		zeta = zetas[k++];
		for (j = start; j < start + 96; ++j) {
			t = fqmul(zeta, a[j + 96]);
			a[j + 96] = barrett_reduce(a[j] - t);
			a[j] = barrett_reduce(a[j] + t);
		}
	}
    for (start = 0; start < 384; start = j + 48) {
		zeta = zetas[k++];
		for (j = start; j < start + 48; ++j) {
			t = fqmul(zeta, a[j + 48]);
            a[j + 48] = (a[j] - t);
			a[j] = (a[j] + t);
		}
	}
    for (start = 0; start < 384; start = j + 24) {
		zeta = zetas[k++];
		for (j = start; j < start + 24; ++j) {
			t = fqmul(zeta, a[j + 24]);
            a[j + 24] = (a[j] - t);
			a[j] = (a[j] + t);
		}
	}
    for (start = 0; start < 384; start = j + 12) {
		zeta = zetas[k++];
		for (j = start; j < start + 12; ++j) {
			t = fqmul(zeta, a[j + 12]);
			a[j + 12] = barrett_reduce(a[j] - t);
			a[j] = barrett_reduce(a[j] + t);
		}
	}
    for (start = 0; start < 384; start = j + 6) {
		zeta = zetas[k++];
		for (j = start; j < start + 6; ++j) {
			t = fqmul(zeta, a[j + 6]);
            a[j + 6] = (a[j] - t);
			a[j] = (a[j] + t);
		}
	}
    for (start = 0; start < 384; start = j + 3) {
		zeta = zetas[k++];
		for (j = start; j < start + 3; ++j) {
			t = fqmul(zeta, a[j + 3]);
            a[j + 3] = (a[j] - t);
			a[j] = (a[j] + t);
		}
	}
    for (start = 0; start < 256; start = j + 1) {
		zeta = zetas[k++];
		for (j = start; j < start + 1; ++j) {
			t = fqmul(zeta, a[j + 1]);
			a[j + 1] = barrett_reduce(a[j] - t);
			a[j] = barrett_reduce(a[j] + t);
		}
	}
}

void ntt(int16_t a[768])
{
	int i;
	int16_t a0[256], a1[256], a2[256];

	for (i = 0; i < 256; i++)
	{
		a0[i] = a[3 * i];
		a1[i] = a[3 * i + 1];
		a2[i] = a[3 * i + 2];
	}
	ntt_256(a0);
	ntt_256(a1);
	ntt_256(a2);

	for (i = 0; i < 256; i++)
	{
		a[3 * i] = a0[i];
		a[3 * i + 1] = a1[i];
		a[3 * i + 2] = a2[i];
	}

}



/********TFNTT_invntt********/
static void invntt_256(int16_t a[256]) {
	unsigned int start, j, k;
	int16_t t, zeta;

	k = 0;

    for (start = 0; start < 256; start = j + 1) {
		zeta = zetas_inv[k++];
		for (j = start; j < start + 1; ++j) {
			t = a[j];
            a[j] = t + a[j + 1];
			a[j + 1] = t - a[j + 1];
			a[j + 1] = fqmul(zeta, a[j + 1]);
		}
	}
    for (start = 0; start < 256; start = j + 2) {
		zeta = zetas_inv[k++];
		for (j = start; j < start + 2; ++j) {
			t = a[j];
			a[j] = barrett_reduce(t + a[j + 2]);
			a[j + 2] = t - a[j + 2];
			a[j + 2] = fqmul(zeta, a[j + 2]);
		}
	}
    for (start = 0; start < 256; start = j + 4) {
		zeta = zetas_inv[k++];
		for (j = start; j < start + 4; ++j) {
			t = a[j];
            a[j] = t + a[j + 4];
			a[j + 4] = t - a[j + 4];
			a[j + 4] = fqmul(zeta, a[j + 4]);
		}
	}
    for (start = 0; start < 256; start = j + 8) {
		zeta = zetas_inv[k++];
		for (j = start; j < start + 8; ++j) {
			t = a[j];
			a[j] = barrett_reduce(t + a[j + 8]);
			a[j + 8] = t - a[j + 8];
			a[j + 8] = fqmul(zeta, a[j + 8]);
		}
	}
    for (start = 0; start < 256; start = j + 16) {
		zeta = zetas_inv[k++];
		for (j = start; j < start + 16; ++j) {
			t = a[j];
            a[j] = t + a[j + 16];
			a[j + 16] = t - a[j + 16];
			a[j + 16] = fqmul(zeta, a[j + 16]);
		}
	}
    for (start = 0; start < 256; start = j + 32) {
		zeta = zetas_inv[k++];
		for (j = start; j < start + 32; ++j) {
			t = a[j];
			a[j] = barrett_reduce(t + a[j + 32]);
			a[j + 32] = t - a[j + 32];
			a[j + 32] = fqmul(zeta, a[j + 32]);
		}
	}
    for (start = 0; start < 256; start = j + 64) {
		zeta = zetas_inv[k++];
		for (j = start; j < start + 64; ++j) {
			t = a[j];
            a[j] = t + a[j + 64];
			a[j + 64] = t - a[j + 64];
			a[j + 64] = fqmul(zeta, a[j + 64]);
		}
	}

	for (j = 0; j < 128; ++j) {
		t = a[j] - a[j + 128];
		t = fqmul(zetas_inv[254], t);
		a[j] = a[j] + a[j + 128];
		a[j] = a[j] - t;
		a[j] = fqmul((1U << 24) % Q, a[j]); // a[j] 在蒙哥马利域，因此最终为 $2^24 * 2^{-16} * 2^{-16} * a_i$, 恰好结合了 lazy reduction
		a[j + 128] = fqmul((1U << 25) % Q, t); // 最后一层少乘一个 1/2
	}
}

void invntt(int16_t a[768]) // 蒙哥马利域上的intt，同时退出蒙哥马利域
{
	int i;
	int16_t a0[256], a1[256], a2[256];

	for (i = 0; i < 256; i++)
	{
		a0[i] = a[3 * i];
		a1[i] = a[3 * i + 1];
		a2[i] = a[3 * i + 2];
	}
	invntt_256(a0);
	invntt_256(a1);
	invntt_256(a2);

	for (i = 0; i < 256; i++)
	{
		a[3 * i] = a0[i];
		a[3 * i + 1] = a1[i];
		a[3 * i + 2] = a2[i];
	}
}
